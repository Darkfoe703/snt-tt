<!-- app/infrastructure/api/web/templates/market.html -->
{% extends "base.html" %}

{% block content %}
<article>
    <hgroup>
        <h1>üìà Mercado</h1>
        <h2>Datos de mercado en tiempo real</h2>
    </hgroup>

    <div class="card">
        <h3>üîç Explorador de Mercado</h3>
        <form action="/market" method="get">
            <input type="hidden" name="submitted" value="true">
            <div class="grid">
                <label for="region_id">
                    Regi√≥n
                    <select id="region_id" name="region_id">
                        {% for region_value, region_name in regions %}
                        <option value="{{ region_value }}" {% if region_id==region_value %}selected{% endif %}>
                            {{ region_name }}
                        </option>
                        {% endfor %}
                    </select>
                </label>
                <label for="min_volume">
                    Volumen M√≠nimo
                    <input type="number" id="min_volume" name="min_volume" value="{{ min_volume }}" required>
                </label>
                <label for="min_spread">
                    Spread M√≠nimo (%)
                    <input type="number" step="0.1" id="min_spread" name="min_spread" value="{{ min_spread }}" required>
                </label>
                <label for="limit">
                    Oportunidades
                    <input type="number" id="limit" name="limit" value="{{ limit }}" required>
                </label>
                <label for="analysis_limit">
                    L√≠mite de An√°lisis
                    <input type="number" id="analysis_limit" name="analysis_limit" value="{{ analysis_limit }}"
                        required>
                </label>
            </div>
            <button type="submit">Analizar Mercado</button>
        </form>
    </div>

    {% if results %}
    <div class="card" style="margin-top: 2rem;">
        <h3>üìä Resultados: {{ results.region_name }}</h3>
        <p>Encontradas <strong>{{ results.total_opportunities }}</strong> oportunidades (Analizados {{
            results.total_items_analyzed }} items)</p>

        <figure>
            <table id="opportunities-table" class="striped">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Compra</th>
                        <th>Venta</th>
                        <th>Ganancia</th>
                        <th>ROI %</th>
                        <th>Volumen</th>
                        <th>Confianza</th>
                    </tr>
                </thead>
                <tbody>
                    {% for opp in results.opportunities %}
                    <tr>
                        <td>{{ opp.name }}</td>
                        <td data-sort="{{ opp.best_buy_price }}">{{ "{:,.0f}".format(opp.best_buy_price) }} ISK</td>
                        <td data-sort="{{ opp.best_sell_price }}">{{ "{:,.0f}".format(opp.best_sell_price) }} ISK</td>
                        <td data-sort="{{ opp.calculate_profit_per_unit() }}">{{
                            "{:,.0f}".format(opp.calculate_profit_per_unit()) }} ISK</td>
                        <td data-sort="{{ opp.calculate_profit_per_unit() / opp.best_buy_price * 100 }}">
                            <strong>{{ "{:.1f}%".format(opp.calculate_profit_per_unit() / opp.best_buy_price * 100)
                                }}</strong>
                        </td>
                        <td data-sort="{{ opp.buy_volume }}">{{ opp.buy_volume }} / {{ opp.sell_volume }}</td>
                        <td data-sort="{{ opp.confidence }}">{{ "{:.0%}".format(opp.confidence) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </figure>

        <!-- Paginaci√≥n -->
        <div class="grid">
            {% if page > 1 %}
            <a href="?region_id={{ region_id }}&min_volume={{ min_volume }}&min_spread={{ min_spread }}&page={{ page - 1 }}"
                role="button" class="outline">‚Üê Anterior</a>
            {% else %}
            <button disabled class="outline">‚Üê Anterior</button>
            {% endif %}

            <div style="text-align: center; padding-top: 10px;">
                P√°gina {{ page }} de {{ total_pages }}
            </div>

            {% if page < total_pages %} <a
                href="?region_id={{ region_id }}&min_volume={{ min_volume }}&min_spread={{ min_spread }}&page={{ page + 1 }}"
                role="button" class="outline">Siguiente ‚Üí</a>
                {% else %}
                <button disabled class="outline">Siguiente ‚Üí</button>
                {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="grid">
        <a href="/" role="button" class="secondary">‚Üê Volver al Dashboard</a>
        <a href="/api/docs" role="button" class="outline">üìö Usar API</a>
    </div>
</article>
{% endblock %}